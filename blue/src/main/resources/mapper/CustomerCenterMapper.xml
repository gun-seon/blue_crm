<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blue.customer.center.mapper.CustomerCenterMapper">

    <!-- 로그인 컨텍스트 -->
    <select id="findUserContextByEmail" resultType="com.blue.customer.all.dto.UserContextDto">
        SELECT
            u.user_id               AS userId,
            u.user_role             AS role,
            u.center_id             AS centerId,
            u.user_email            AS email,
            u.manager_phone_access  AS visible
        FROM users u
        WHERE u.user_email = #{email}
        LIMIT 1
    </select>

    <!-- 본사 제외 센터 목록 -->
    <select id="findCentersExcludingHQ" resultType="com.blue.customer.center.dto.CenterSimpleDto">
        SELECT
            c.center_id   AS centerId,
            c.center_name AS centerName
        FROM centers c
        WHERE c.center_id &lt;&gt; 1
        ORDER BY c.center_id ASC
    </select>

    <!-- 공용 필터 (센터DB 전용) : t.* 에 적용 -->
    <sql id="COMMON_FILTERS">
        <!-- 키워드: SUPERADMIN이지만 visible=='N'이면 이름만 검색 (전화 검색 금지) -->
        <if test="keyword != null and keyword != ''">
            <choose>
                <when test='visible == "N"'>
                    AND (t.name LIKE CONCAT('%', #{keyword}, '%'))
                </when>
                <otherwise>
                    AND (
                    t.name  LIKE CONCAT('%', #{keyword}, '%')
                    OR t.phone LIKE CONCAT('%', #{keyword}, '%')
                    )
                </otherwise>
            </choose>
        </if>

        <!-- 날짜 -->
        <if test="dateFrom != null and dateFrom != ''">
            AND t.createdAt &gt;= #{dateFrom}
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND t.createdAt &lt; DATE_ADD(#{dateTo}, INTERVAL 1 DAY)
        </if>

        <!-- 구분(최초/유효/중복) -->
        <if test="division != null and division != ''">
            AND t.division = #{division}
        </if>

        <!-- 센터 드롭다운 (null이면 전체) -->
        <if test="centerId != null">
            AND t.centerId = #{centerId}
        </if>
    </sql>

    <!-- SUPERADMIN 전용: 고객 + 중복 (센터 없는 항목/본사 소속 제외) -->
    <select id="findForAdmin" resultType="com.blue.customer.center.dto.CenterDbRowDto">
        SELECT
        t.id,
        t.createdAt,
        t.name,
        t.phone,
        t.centerId,
        t.centerName
        FROM (
        SELECT
        c.customer_id          AS id,
        c.customer_created_at  AS createdAt,
        c.customer_name        AS name,
        c.customer_phone       AS phone,
        u.center_id            AS centerId,
        ce.center_name         AS centerName,
        c.customer_division    AS division
        FROM customers c
        JOIN users   u   ON u.user_id    = c.user_id
        JOIN centers ce  ON ce.center_id = u.center_id
        WHERE 1=1
        AND u.center_id &lt;&gt; 1
        AND c.user_id IS NOT NULL
        AND u.center_id IS NOT NULL
        ) t
        WHERE 1=1
        <include refid="COMMON_FILTERS"/>
        ORDER BY t.createdAt DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countForAdmin" resultType="int">
        SELECT COUNT(*)
        FROM (
        SELECT
        c.customer_id          AS id,
        c.customer_created_at  AS createdAt,
        c.customer_name        AS name,
        c.customer_phone       AS phone,
        u.center_id            AS centerId,
        ce.center_name         AS centerName,
        c.customer_division    AS division
        FROM customers c
        JOIN users   u   ON u.user_id    = c.user_id
        JOIN centers ce  ON ce.center_id = u.center_id
        WHERE 1=1
        AND u.center_id &lt;&gt; 1
        AND c.user_id IS NOT NULL
        AND u.center_id IS NOT NULL
        ) t
        WHERE 1=1
        <include refid="COMMON_FILTERS"/>
    </select>

</mapper>
