<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.blue.user.mapper.UserMapper">

    <!-- 직원 목록 조회 -->
    <select id="findUsers" resultType="com.blue.user.dto.UserSelectDto">
        SELECT
        u.user_id     AS userId,
        u.user_name   AS userName,
        u.user_phone  AS userPhone,
        u.user_email  AS userEmail,
        u.user_role   AS userRole,
        u.user_approved AS userApproved,
        c.center_name AS centerName
        FROM users u
        LEFT JOIN centers c ON u.center_id = c.center_id
        <where>
            <if test="keyword != null and keyword != ''">
                AND (u.user_name LIKE CONCAT('%', #{keyword}, '%')
                OR u.user_email LIKE CONCAT('%', #{keyword}, '%')
                OR u.user_phone LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY u.user_created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 직원 수 -->
    <select id="countUsers" resultType="int">
        SELECT COUNT(*)
        FROM users u
        <where>
            <if test="keyword != null and keyword != ''">
                AND (u.user_name LIKE CONCAT('%', #{keyword}, '%')
                OR u.user_email LIKE CONCAT('%', #{keyword}, '%')
                OR u.user_phone LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
    </select>

    <!-- Badge 업데이트 -->
    <update id="updateUserField">
        UPDATE users
        <set>
            <choose>
                <when test="field == 'center'">
                    center_id = (SELECT center_id FROM centers WHERE center_name = #{value})
                </when>
                <when test="field == 'requestStatus'">
                    user_approved =
                    CASE
                    WHEN #{value} = '승인' THEN 'Y'
                    WHEN #{value} = '대기' THEN 'N'
                    ELSE 'N'
                    END
                </when>
                <when test="field == 'type'">
                    user_role =
                    CASE
                    WHEN #{value} = '관리자' THEN 'SUPERADMIN'
                    WHEN #{value} = '센터장' THEN 'MANAGER'
                    WHEN #{value} = '담당자' THEN 'STAFF'
                    END
                </when>
            </choose>
        </set>
        WHERE user_id = #{userId}
    </update>

</mapper>